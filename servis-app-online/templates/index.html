<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pendataan Servis HP & Laptop</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="container py-4">
  <h1 class="mb-3">Pendataan Servis HP & Laptop</h1>

  <!-- Form input -->
  <div class="card mb-3">
    <div class="card-body">
      <form id="form-servis" class="row g-2">
        <div class="col-md-2">
          <label class="form-label">Tanggal</label>
          <input name="tanggal" id="tanggal" class="form-control" type="date" value="">
        </div>
        <div class="col-md-5">
          <label class="form-label">Nama</label>
          <input name="nama" id="nama" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Kontak</label>
          <input name="kontak" id="kontak" class="form-control">
        </div>
        <div class="col-md-2">
          <label class="form-label">Tipe</label>
          <select id="tipe" class="form-select">
            <option>HP</option><option>Laptop</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Merek/Model</label>
          <input id="merek_model" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">Status</label>
          <select id="status" class="form-select">
            <option>Masuk</option><option>Diperiksa</option><option>Diperbaiki</option><option>Menunggu Sparepart</option><option>Selesai</option><option>Diambil</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Keluhan</label>
          <textarea id="keluhan" class="form-control" rows="2"></textarea>
        </div>
        <div class="col-md-2">
          <label class="form-label">Estimasi</label>
          <input id="estimasi" class="form-control" type="number" min="0" value="0">
        </div>
        <div class="col-md-2">
          <label class="form-label">Biaya Real</label>
          <input id="biaya_real" class="form-control" type="number" min="0" value="0">
        </div>
        <div class="col-md-2">
          <label class="form-label">DP</label>
          <input id="dp" class="form-control" type="number" min="0" value="0">
        </div>

        <div class="col-12 text-end">
          <button type="submit" class="btn btn-primary">Simpan</button>
          <button id="btn-clear" type="button" class="btn btn-secondary">Clear</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Filter & Table -->
  <div class="d-flex mb-2 gap-2">
    <input id="q" class="form-control" placeholder="Cari nama / kontak / merek" />
    <select id="filter-tipe" class="form-select w-auto"><option>Semua</option><option>HP</option><option>Laptop</option></select>
    <select id="filter-status" class="form-select w-auto"><option>Semua</option><option>Masuk</option><option>Diperiksa</option><option>Diperbaiki</option><option>Menunggu Sparepart</option><option>Selesai</option><option>Diambil</option></select>
    <button id="btn-filter" class="btn btn-outline-secondary">Filter</button>
  </div>

  <div class="table-responsive">
    <table class="table table-sm table-hover" id="tbl">
      <thead class="table-light"><tr>
        <th>#</th><th>Tanggal</th><th>Nama</th><th>Kontak</th><th>Tipe</th><th>Merek/Model</th><th>Keluhan</th><th>Status</th><th>Estimasi</th><th>Real</th><th>DP</th><th>Sisa</th><th>Aksi</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const apiBase = '/api/servis';
const dateInput = document.getElementById('tanggal');
dateInput.value = new Date().toISOString().slice(0,10);

async function fetchData(){
  const q = document.getElementById('q').value;
  const tipe = document.getElementById('filter-tipe').value;
  const status = document.getElementById('filter-status').value;
  const params = new URLSearchParams();
  if(q) params.append('keyword', q);
  if(tipe) params.append('tipe', tipe);
  if(status) params.append('status', status);
  const res = await fetch(apiBase + (params.toString() ? ('?'+params.toString()) : ''));
  const data = await res.json();
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '';
  data.forEach(d => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${d.id}</td>
      <td>${d.tanggal}</td>
      <td>${d.nama}</td>
      <td>${d.kontak || ''}</td>
      <td>${d.tipe || ''}</td>
      <td>${d.merek_model || ''}</td>
      <td>${d.keluhan || ''}</td>
      <td>${d.status || ''}</td>
      <td>${d.estimasi_biaya ?? 0}</td>
      <td>${d.biaya_real ?? 0}</td>
      <td>${d.dp ?? 0}</td>
      <td>${d.sisa ?? 0}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="edit(${d.id})">Edit</button>
        <button class="btn btn-sm btn-outline-danger" onclick="hapus(${d.id})">Hapus</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

document.getElementById('btn-filter').addEventListener('click', fetchData);
document.getElementById('q').addEventListener('keyup', (e)=> { if(e.key==='Enter') fetchData(); });

document.getElementById('form-servis').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const payload = {
    tanggal: document.getElementById('tanggal').value,
    nama: document.getElementById('nama').value,
    kontak: document.getElementById('kontak').value,
    tipe: document.getElementById('tipe').value,
    merek_model: document.getElementById('merek_model').value,
    keluhan: document.getElementById('keluhan').value,
    status: document.getElementById('status').value,
    estimasi_biaya: Number(document.getElementById('estimasi').value||0),
    biaya_real: Number(document.getElementById('biaya_real').value||0),
    dp: Number(document.getElementById('dp').value||0)
  };
  const res = await fetch(apiBase, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  if(res.ok){
    alert('Tersimpan');
    fetchData();
    document.getElementById('form-servis').reset();
    dateInput.value = new Date().toISOString().slice(0,10);
  } else {
    const err = await res.json();
    alert('Gagal: ' + (err.error || JSON.stringify(err)));
  }
});

document.getElementById('btn-clear').addEventListener('click', ()=>{
  document.getElementById('form-servis').reset();
  dateInput.value = new Date().toISOString().slice(0,10);
});

async function hapus(id){
  if(!confirm('Hapus id '+id+'?')) return;
  const res = await fetch(apiBase + '/' + id, {method:'DELETE'});
  if(res.ok){ fetchData(); } else { alert('Gagal menghapus'); }
}

async function edit(id){
  // ambil data tunggal via fetch list + filter id (simple)
  const res = await fetch(apiBase + '?keyword=' + id);
  const arr = await res.json();
  const row = arr.find(r => Number(r.id) === Number(id));
  if(!row){ alert('Data tidak ditemukan'); return; }
  document.getElementById('tanggal').value = row.tanggal || new Date().toISOString().slice(0,10);
  document.getElementById('nama').value = row.nama || '';
  document.getElementById('kontak').value = row.kontak || '';
  document.getElementById('tipe').value = row.tipe || 'HP';
  document.getElementById('merek_model').value = row.merek_model || '';
  document.getElementById('keluhan').value = row.keluhan || '';
  document.getElementById('status').value = row.status || 'Masuk';
  document.getElementById('estimasi').value = row.estimasi_biaya || 0;
  document.getElementById('biaya_real').value = row.biaya_real || 0;
  document.getElementById('dp').value = row.dp || 0;

  // Replace submit to do PUT
  const form = document.getElementById('form-servis');
  form.onsubmit = async (ev) => {
    ev.preventDefault();
    const payload = {
      tanggal: document.getElementById('tanggal').value,
      nama: document.getElementById('nama').value,
      kontak: document.getElementById('kontak').value,
      tipe: document.getElementById('tipe').value,
      merek_model: document.getElementById('merek_model').value,
      keluhan: document.getElementById('keluhan').value,
      status: document.getElementById('status').value,
      estimasi_biaya: Number(document.getElementById('estimasi').value||0),
      biaya_real: Number(document.getElementById('biaya_real').value||0),
      dp: Number(document.getElementById('dp').value||0)
    };
    const r = await fetch(apiBase + '/' + id, {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(r.ok){
      alert('Diupdate');
      fetchData();
      form.reset();
      form.onsubmit = null; // restore default (user can add new)
      dateInput.value = new Date().toISOString().slice(0,10);
    } else {
      const er = await r.json();
      alert('Gagal update: ' + (er.error || JSON.stringify(er)));
    }
  };
  window.scrollTo({top:0, behavior:'smooth'});
}

fetchData();
</script>
</body>
</html>
